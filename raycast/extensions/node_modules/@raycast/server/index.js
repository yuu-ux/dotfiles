"use strict";var fs=Object.create;var Yr=Object.defineProperty;var hs=Object.getOwnPropertyDescriptor;var ms=Object.getOwnPropertyNames;var ps=Object.getPrototypeOf,gs=Object.prototype.hasOwnProperty;var q=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var ys=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ms(e))!gs.call(t,i)&&i!==r&&Yr(t,i,{get:()=>e[i],enumerable:!(n=hs(e,i))||n.enumerable});return t};var bs=(t,e,r)=>(r=t!=null?fs(ps(t)):{},ys(e||!t||!t.__esModule?Yr(r,"default",{value:t,enumerable:!0}):r,t));var ke=q($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.stringArray=$.array=$.func=$.error=$.number=$.string=$.boolean=void 0;function ws(t){return t===!0||t===!1}$.boolean=ws;function Zr(t){return typeof t=="string"||t instanceof String}$.string=Zr;function vs(t){return typeof t=="number"||t instanceof Number}$.number=vs;function ks(t){return t instanceof Error}$.error=ks;function Ps(t){return typeof t=="function"}$.func=Ps;function en(t){return Array.isArray(t)}$.array=en;function _s(t){return en(t)&&t.every(e=>Zr(e))}$.stringArray=_s});var Ft=q(l=>{"use strict";Object.defineProperty(l,"__esModule",{value:!0});l.Message=l.NotificationType9=l.NotificationType8=l.NotificationType7=l.NotificationType6=l.NotificationType5=l.NotificationType4=l.NotificationType3=l.NotificationType2=l.NotificationType1=l.NotificationType0=l.NotificationType=l.RequestType9=l.RequestType8=l.RequestType7=l.RequestType6=l.RequestType5=l.RequestType4=l.RequestType3=l.RequestType2=l.RequestType1=l.RequestType=l.RequestType0=l.AbstractMessageSignature=l.ParameterStructures=l.ResponseError=l.ErrorCodes=void 0;var he=ke(),kt;(function(t){t.ParseError=-32700,t.InvalidRequest=-32600,t.MethodNotFound=-32601,t.InvalidParams=-32602,t.InternalError=-32603,t.jsonrpcReservedErrorRangeStart=-32099,t.serverErrorStart=-32099,t.MessageWriteError=-32099,t.MessageReadError=-32098,t.PendingResponseRejected=-32097,t.ConnectionInactive=-32096,t.ServerNotInitialized=-32002,t.UnknownErrorCode=-32001,t.jsonrpcReservedErrorRangeEnd=-32e3,t.serverErrorEnd=-32e3})(kt||(l.ErrorCodes=kt={}));var Pt=class t extends Error{constructor(e,r,n){super(r),this.code=he.number(e)?e:kt.UnknownErrorCode,this.data=n,Object.setPrototypeOf(this,t.prototype)}toJson(){let e={code:this.code,message:this.message};return this.data!==void 0&&(e.data=this.data),e}};l.ResponseError=Pt;var H=class t{constructor(e){this.kind=e}static is(e){return e===t.auto||e===t.byName||e===t.byPosition}toString(){return this.kind}};l.ParameterStructures=H;H.auto=new H("auto");H.byPosition=new H("byPosition");H.byName=new H("byName");var E=class{constructor(e,r){this.method=e,this.numberOfParams=r}get parameterStructures(){return H.auto}};l.AbstractMessageSignature=E;var _t=class extends E{constructor(e){super(e,0)}};l.RequestType0=_t;var Rt=class extends E{constructor(e,r=H.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.RequestType=Rt;var St=class extends E{constructor(e,r=H.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.RequestType1=St;var Et=class extends E{constructor(e){super(e,2)}};l.RequestType2=Et;var Mt=class extends E{constructor(e){super(e,3)}};l.RequestType3=Mt;var Tt=class extends E{constructor(e){super(e,4)}};l.RequestType4=Tt;var xt=class extends E{constructor(e){super(e,5)}};l.RequestType5=xt;var Nt=class extends E{constructor(e){super(e,6)}};l.RequestType6=Nt;var Ot=class extends E{constructor(e){super(e,7)}};l.RequestType7=Ot;var Ct=class extends E{constructor(e){super(e,8)}};l.RequestType8=Ct;var It=class extends E{constructor(e){super(e,9)}};l.RequestType9=It;var jt=class extends E{constructor(e,r=H.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.NotificationType=jt;var qt=class extends E{constructor(e){super(e,0)}};l.NotificationType0=qt;var Lt=class extends E{constructor(e,r=H.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.NotificationType1=Lt;var At=class extends E{constructor(e){super(e,2)}};l.NotificationType2=At;var $t=class extends E{constructor(e){super(e,3)}};l.NotificationType3=$t;var Dt=class extends E{constructor(e){super(e,4)}};l.NotificationType4=Dt;var Wt=class extends E{constructor(e){super(e,5)}};l.NotificationType5=Wt;var zt=class extends E{constructor(e){super(e,6)}};l.NotificationType6=zt;var Bt=class extends E{constructor(e){super(e,7)}};l.NotificationType7=Bt;var Ht=class extends E{constructor(e){super(e,8)}};l.NotificationType8=Ht;var Ut=class extends E{constructor(e){super(e,9)}};l.NotificationType9=Ut;var tn;(function(t){function e(i){let c=i;return c&&he.string(c.method)&&(he.string(c.id)||he.number(c.id))}t.isRequest=e;function r(i){let c=i;return c&&he.string(c.method)&&i.id===void 0}t.isNotification=r;function n(i){let c=i;return c&&(c.result!==void 0||!!c.error)&&(he.string(c.id)||he.number(c.id)||c.id===null)}t.isResponse=n})(tn||(l.Message=tn={}))});var Jt=q(ae=>{"use strict";var rn;Object.defineProperty(ae,"__esModule",{value:!0});ae.LRUCache=ae.LinkedMap=ae.Touch=void 0;var D;(function(t){t.None=0,t.First=1,t.AsOld=t.First,t.Last=2,t.AsNew=t.Last})(D||(ae.Touch=D={}));var Je=class{constructor(){this[rn]="LinkedMap",this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){return this._head?.value}get last(){return this._tail?.value}has(e){return this._map.has(e)}get(e,r=D.None){let n=this._map.get(e);if(n)return r!==D.None&&this.touch(n,r),n.value}set(e,r,n=D.None){let i=this._map.get(e);if(i)i.value=r,n!==D.None&&this.touch(i,n);else{switch(i={key:e,value:r,next:void 0,previous:void 0},n){case D.None:this.addItemLast(i);break;case D.First:this.addItemFirst(i);break;case D.Last:this.addItemLast(i);break;default:this.addItemLast(i);break}this._map.set(e,i),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let r=this._map.get(e);if(r)return this._map.delete(e),this.removeItem(r),this._size--,r.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,r){let n=this._state,i=this._head;for(;i;){if(r?e.bind(r)(i.value,i.key,this):e(i.value,i.key,this),this._state!==n)throw new Error("LinkedMap got modified during iteration.");i=i.next}}keys(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:r.key,done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}values(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:r.value,done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}entries(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:[r.key,r.value],done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}[(rn=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let r=this._head,n=this.size;for(;r&&n>e;)this._map.delete(r.key),r=r.next,n--;this._head=r,this._size=n,r&&(r.previous=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let r=e.next,n=e.previous;if(!r||!n)throw new Error("Invalid list");r.previous=n,n.next=r}e.next=void 0,e.previous=void 0,this._state++}touch(e,r){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(r!==D.First&&r!==D.Last)){if(r===D.First){if(e===this._head)return;let n=e.next,i=e.previous;e===this._tail?(i.next=void 0,this._tail=i):(n.previous=i,i.next=n),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(r===D.Last){if(e===this._tail)return;let n=e.next,i=e.previous;e===this._head?(n.previous=void 0,this._head=n):(n.previous=i,i.next=n),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((r,n)=>{e.push([n,r])}),e}fromJSON(e){this.clear();for(let[r,n]of e)this.set(r,n)}};ae.LinkedMap=Je;var Vt=class extends Je{constructor(e,r=1){super(),this._limit=e,this._ratio=Math.min(Math.max(0,r),1)}get limit(){return this._limit}set limit(e){this._limit=e,this.checkTrim()}get ratio(){return this._ratio}set ratio(e){this._ratio=Math.min(Math.max(0,e),1),this.checkTrim()}get(e,r=D.AsNew){return super.get(e,r)}peek(e){return super.get(e,D.None)}set(e,r){return super.set(e,r,D.Last),this.checkTrim(),this}checkTrim(){this.size>this._limit&&this.trimOld(Math.round(this._limit*this._ratio))}};ae.LRUCache=Vt});var sn=q(Ge=>{"use strict";Object.defineProperty(Ge,"__esModule",{value:!0});Ge.Disposable=void 0;var nn;(function(t){function e(r){return{dispose:r}}t.create=e})(nn||(Ge.Disposable=nn={}))});var ce=q(Kt=>{"use strict";Object.defineProperty(Kt,"__esModule",{value:!0});var Gt;function Qt(){if(Gt===void 0)throw new Error("No runtime abstraction layer installed");return Gt}(function(t){function e(r){if(r===void 0)throw new Error("No runtime abstraction layer provided");Gt=r}t.install=e})(Qt||(Qt={}));Kt.default=Qt});var _e=q(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.Emitter=Pe.Event=void 0;var Rs=ce(),on;(function(t){let e={dispose(){}};t.None=function(){return e}})(on||(Pe.Event=on={}));var Xt=class{add(e,r=null,n){this._callbacks||(this._callbacks=[],this._contexts=[]),this._callbacks.push(e),this._contexts.push(r),Array.isArray(n)&&n.push({dispose:()=>this.remove(e,r)})}remove(e,r=null){if(!this._callbacks)return;let n=!1;for(let i=0,c=this._callbacks.length;i<c;i++)if(this._callbacks[i]===e)if(this._contexts[i]===r){this._callbacks.splice(i,1),this._contexts.splice(i,1);return}else n=!0;if(n)throw new Error("When adding a listener with a context, you should remove it with the same context")}invoke(...e){if(!this._callbacks)return[];let r=[],n=this._callbacks.slice(0),i=this._contexts.slice(0);for(let c=0,m=n.length;c<m;c++)try{r.push(n[c].apply(i[c],e))}catch(g){(0,Rs.default)().console.error(g)}return r}isEmpty(){return!this._callbacks||this._callbacks.length===0}dispose(){this._callbacks=void 0,this._contexts=void 0}},Qe=class t{constructor(e){this._options=e}get event(){return this._event||(this._event=(e,r,n)=>{this._callbacks||(this._callbacks=new Xt),this._options&&this._options.onFirstListenerAdd&&this._callbacks.isEmpty()&&this._options.onFirstListenerAdd(this),this._callbacks.add(e,r);let i={dispose:()=>{this._callbacks&&(this._callbacks.remove(e,r),i.dispose=t._noop,this._options&&this._options.onLastListenerRemove&&this._callbacks.isEmpty()&&this._options.onLastListenerRemove(this))}};return Array.isArray(n)&&n.push(i),i}),this._event}fire(e){this._callbacks&&this._callbacks.invoke.call(this._callbacks,e)}dispose(){this._callbacks&&(this._callbacks.dispose(),this._callbacks=void 0)}};Pe.Emitter=Qe;Qe._noop=function(){}});var Ye=q(Re=>{"use strict";Object.defineProperty(Re,"__esModule",{value:!0});Re.CancellationTokenSource=Re.CancellationToken=void 0;var Ss=ce(),Es=ke(),Yt=_e(),Ke;(function(t){t.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:Yt.Event.None}),t.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:Yt.Event.None});function e(r){let n=r;return n&&(n===t.None||n===t.Cancelled||Es.boolean(n.isCancellationRequested)&&!!n.onCancellationRequested)}t.is=e})(Ke||(Re.CancellationToken=Ke={}));var Ms=Object.freeze(function(t,e){let r=(0,Ss.default)().timer.setTimeout(t.bind(e),0);return{dispose(){r.dispose()}}}),Xe=class{constructor(){this._isCancelled=!1}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?Ms:(this._emitter||(this._emitter=new Yt.Emitter),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}},Zt=class{get token(){return this._token||(this._token=new Xe),this._token}cancel(){this._token?this._token.cancel():this._token=Ke.Cancelled}dispose(){this._token?this._token instanceof Xe&&this._token.dispose():this._token=Ke.None}};Re.CancellationTokenSource=Zt});var an=q(Se=>{"use strict";Object.defineProperty(Se,"__esModule",{value:!0});Se.SharedArrayReceiverStrategy=Se.SharedArraySenderStrategy=void 0;var Ts=Ye(),qe;(function(t){t.Continue=0,t.Cancelled=1})(qe||(qe={}));var er=class{constructor(){this.buffers=new Map}enableCancellation(e){if(e.id===null)return;let r=new SharedArrayBuffer(4),n=new Int32Array(r,0,1);n[0]=qe.Continue,this.buffers.set(e.id,r),e.$cancellationData=r}async sendCancellation(e,r){let n=this.buffers.get(r);if(n===void 0)return;let i=new Int32Array(n,0,1);Atomics.store(i,0,qe.Cancelled)}cleanup(e){this.buffers.delete(e)}dispose(){this.buffers.clear()}};Se.SharedArraySenderStrategy=er;var tr=class{constructor(e){this.data=new Int32Array(e,0,1)}get isCancellationRequested(){return Atomics.load(this.data,0)===qe.Cancelled}get onCancellationRequested(){throw new Error("Cancellation over SharedArrayBuffer doesn't support cancellation events")}},rr=class{constructor(e){this.token=new tr(e)}cancel(){}dispose(){}},nr=class{constructor(){this.kind="request"}createCancellationTokenSource(e){let r=e.$cancellationData;return r===void 0?new Ts.CancellationTokenSource:new rr(r)}};Se.SharedArrayReceiverStrategy=nr});var ir=q(Ze=>{"use strict";Object.defineProperty(Ze,"__esModule",{value:!0});Ze.Semaphore=void 0;var xs=ce(),sr=class{constructor(e=1){if(e<=0)throw new Error("Capacity must be greater than 0");this._capacity=e,this._active=0,this._waiting=[]}lock(e){return new Promise((r,n)=>{this._waiting.push({thunk:e,resolve:r,reject:n}),this.runNext()})}get active(){return this._active}runNext(){this._waiting.length===0||this._active===this._capacity||(0,xs.default)().timer.setImmediate(()=>this.doRunNext())}doRunNext(){if(this._waiting.length===0||this._active===this._capacity)return;let e=this._waiting.shift();if(this._active++,this._active>this._capacity)throw new Error("To many thunks active");try{let r=e.thunk();r instanceof Promise?r.then(n=>{this._active--,e.resolve(n),this.runNext()},n=>{this._active--,e.reject(n),this.runNext()}):(this._active--,e.resolve(r),this.runNext())}catch(r){this._active--,e.reject(r),this.runNext()}}};Ze.Semaphore=sr});var un=q(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.ReadableStreamMessageReader=ue.AbstractMessageReader=ue.MessageReader=void 0;var ar=ce(),Ee=ke(),or=_e(),Ns=ir(),cn;(function(t){function e(r){let n=r;return n&&Ee.func(n.listen)&&Ee.func(n.dispose)&&Ee.func(n.onError)&&Ee.func(n.onClose)&&Ee.func(n.onPartialMessage)}t.is=e})(cn||(ue.MessageReader=cn={}));var et=class{constructor(){this.errorEmitter=new or.Emitter,this.closeEmitter=new or.Emitter,this.partialMessageEmitter=new or.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e){this.errorEmitter.fire(this.asError(e))}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}get onPartialMessage(){return this.partialMessageEmitter.event}firePartialMessage(e){this.partialMessageEmitter.fire(e)}asError(e){return e instanceof Error?e:new Error(`Reader received error. Reason: ${Ee.string(e.message)?e.message:"unknown"}`)}};ue.AbstractMessageReader=et;var cr;(function(t){function e(r){let n,i,c,m=new Map,g,_=new Map;if(r===void 0||typeof r=="string")n=r??"utf-8";else{if(n=r.charset??"utf-8",r.contentDecoder!==void 0&&(c=r.contentDecoder,m.set(c.name,c)),r.contentDecoders!==void 0)for(let R of r.contentDecoders)m.set(R.name,R);if(r.contentTypeDecoder!==void 0&&(g=r.contentTypeDecoder,_.set(g.name,g)),r.contentTypeDecoders!==void 0)for(let R of r.contentTypeDecoders)_.set(R.name,R)}return g===void 0&&(g=(0,ar.default)().applicationJson.decoder,_.set(g.name,g)),{charset:n,contentDecoder:c,contentDecoders:m,contentTypeDecoder:g,contentTypeDecoders:_}}t.fromOptions=e})(cr||(cr={}));var ur=class extends et{constructor(e,r){super(),this.readable=e,this.options=cr.fromOptions(r),this.buffer=(0,ar.default)().messageBuffer.create(this.options.charset),this._partialMessageTimeout=1e4,this.nextMessageLength=-1,this.messageToken=0,this.readSemaphore=new Ns.Semaphore(1)}set partialMessageTimeout(e){this._partialMessageTimeout=e}get partialMessageTimeout(){return this._partialMessageTimeout}listen(e){this.nextMessageLength=-1,this.messageToken=0,this.partialMessageTimer=void 0,this.callback=e;let r=this.readable.onData(n=>{this.onData(n)});return this.readable.onError(n=>this.fireError(n)),this.readable.onClose(()=>this.fireClose()),r}onData(e){try{for(this.buffer.append(e);;){if(this.nextMessageLength===-1){let n=this.buffer.tryReadHeaders(!0);if(!n)return;let i=n.get("content-length");if(!i){this.fireError(new Error(`Header must provide a Content-Length property.
${JSON.stringify(Object.fromEntries(n))}`));return}let c=parseInt(i);if(isNaN(c)){this.fireError(new Error(`Content-Length value must be a number. Got ${i}`));return}this.nextMessageLength=c}let r=this.buffer.tryReadBody(this.nextMessageLength);if(r===void 0){this.setPartialMessageTimer();return}this.clearPartialMessageTimer(),this.nextMessageLength=-1,this.readSemaphore.lock(async()=>{let n=this.options.contentDecoder!==void 0?await this.options.contentDecoder.decode(r):r,i=await this.options.contentTypeDecoder.decode(n,this.options);this.callback(i)}).catch(n=>{this.fireError(n)})}}catch(r){this.fireError(r)}}clearPartialMessageTimer(){this.partialMessageTimer&&(this.partialMessageTimer.dispose(),this.partialMessageTimer=void 0)}setPartialMessageTimer(){this.clearPartialMessageTimer(),!(this._partialMessageTimeout<=0)&&(this.partialMessageTimer=(0,ar.default)().timer.setTimeout((e,r)=>{this.partialMessageTimer=void 0,e===this.messageToken&&(this.firePartialMessage({messageToken:e,waitingTime:r}),this.setPartialMessageTimer())},this._partialMessageTimeout,this.messageToken,this._partialMessageTimeout))}};ue.ReadableStreamMessageReader=ur});var mn=q(de=>{"use strict";Object.defineProperty(de,"__esModule",{value:!0});de.WriteableStreamMessageWriter=de.AbstractMessageWriter=de.MessageWriter=void 0;var dn=ce(),Le=ke(),Os=ir(),ln=_e(),Cs="Content-Length: ",fn=`\r
`,hn;(function(t){function e(r){let n=r;return n&&Le.func(n.dispose)&&Le.func(n.onClose)&&Le.func(n.onError)&&Le.func(n.write)}t.is=e})(hn||(de.MessageWriter=hn={}));var tt=class{constructor(){this.errorEmitter=new ln.Emitter,this.closeEmitter=new ln.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e,r,n){this.errorEmitter.fire([this.asError(e),r,n])}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}asError(e){return e instanceof Error?e:new Error(`Writer received error. Reason: ${Le.string(e.message)?e.message:"unknown"}`)}};de.AbstractMessageWriter=tt;var dr;(function(t){function e(r){return r===void 0||typeof r=="string"?{charset:r??"utf-8",contentTypeEncoder:(0,dn.default)().applicationJson.encoder}:{charset:r.charset??"utf-8",contentEncoder:r.contentEncoder,contentTypeEncoder:r.contentTypeEncoder??(0,dn.default)().applicationJson.encoder}}t.fromOptions=e})(dr||(dr={}));var lr=class extends tt{constructor(e,r){super(),this.writable=e,this.options=dr.fromOptions(r),this.errorCount=0,this.writeSemaphore=new Os.Semaphore(1),this.writable.onError(n=>this.fireError(n)),this.writable.onClose(()=>this.fireClose())}async write(e){return this.writeSemaphore.lock(async()=>this.options.contentTypeEncoder.encode(e,this.options).then(n=>this.options.contentEncoder!==void 0?this.options.contentEncoder.encode(n):n).then(n=>{let i=[];return i.push(Cs,n.byteLength.toString(),fn),i.push(fn),this.doWrite(e,i,n)},n=>{throw this.fireError(n),n}))}async doWrite(e,r,n){try{return await this.writable.write(r.join(""),"ascii"),this.writable.write(n)}catch(i){return this.handleError(i,e),Promise.reject(i)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){this.writable.end()}};de.WriteableStreamMessageWriter=lr});var pn=q(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.AbstractMessageBuffer=void 0;var Is=13,js=10,qs=`\r
`,fr=class{constructor(e="utf-8"){this._encoding=e,this._chunks=[],this._totalLength=0}get encoding(){return this._encoding}append(e){let r=typeof e=="string"?this.fromString(e,this._encoding):e;this._chunks.push(r),this._totalLength+=r.byteLength}tryReadHeaders(e=!1){if(this._chunks.length===0)return;let r=0,n=0,i=0,c=0;e:for(;n<this._chunks.length;){let R=this._chunks[n];for(i=0;i<R.length;){switch(R[i]){case Is:switch(r){case 0:r=1;break;case 2:r=3;break;default:r=0}break;case js:switch(r){case 1:r=2;break;case 3:r=4,i++;break e;default:r=0}break;default:r=0}i++}c+=R.byteLength,n++}if(r!==4)return;let m=this._read(c+i),g=new Map,_=this.toString(m,"ascii").split(qs);if(_.length<2)return g;for(let R=0;R<_.length-2;R++){let A=_[R],B=A.indexOf(":");if(B===-1)throw new Error(`Message header must separate key and value using ':'
${A}`);let J=A.substr(0,B),G=A.substr(B+1).trim();g.set(e?J.toLowerCase():J,G)}return g}tryReadBody(e){if(!(this._totalLength<e))return this._read(e)}get numberOfBytes(){return this._totalLength}_read(e){if(e===0)return this.emptyBuffer();if(e>this._totalLength)throw new Error("Cannot read so many bytes!");if(this._chunks[0].byteLength===e){let c=this._chunks[0];return this._chunks.shift(),this._totalLength-=e,this.asNative(c)}if(this._chunks[0].byteLength>e){let c=this._chunks[0],m=this.asNative(c,e);return this._chunks[0]=c.slice(e),this._totalLength-=e,m}let r=this.allocNative(e),n=0,i=0;for(;e>0;){let c=this._chunks[i];if(c.byteLength>e){let m=c.slice(0,e);r.set(m,n),n+=e,this._chunks[i]=c.slice(e),this._totalLength-=e,e-=e}else r.set(c,n),n+=c.byteLength,this._chunks.shift(),this._totalLength-=c.byteLength,e-=c.byteLength}return r}};rt.AbstractMessageBuffer=fr});var vn=q(h=>{"use strict";Object.defineProperty(h,"__esModule",{value:!0});h.createMessageConnection=h.ConnectionOptions=h.MessageStrategy=h.CancellationStrategy=h.CancellationSenderStrategy=h.CancellationReceiverStrategy=h.RequestCancellationReceiverStrategy=h.IdCancellationReceiverStrategy=h.ConnectionStrategy=h.ConnectionError=h.ConnectionErrors=h.LogTraceNotification=h.SetTraceNotification=h.TraceFormat=h.TraceValues=h.Trace=h.NullLogger=h.ProgressType=h.ProgressToken=void 0;var gn=ce(),x=ke(),f=Ft(),yn=Jt(),Ae=_e(),hr=Ye(),We;(function(t){t.type=new f.NotificationType("$/cancelRequest")})(We||(We={}));var mr;(function(t){function e(r){return typeof r=="string"||typeof r=="number"}t.is=e})(mr||(h.ProgressToken=mr={}));var $e;(function(t){t.type=new f.NotificationType("$/progress")})($e||($e={}));var pr=class{constructor(){}};h.ProgressType=pr;var gr;(function(t){function e(r){return x.func(r)}t.is=e})(gr||(gr={}));h.NullLogger=Object.freeze({error:()=>{},warn:()=>{},info:()=>{},log:()=>{}});var b;(function(t){t[t.Off=0]="Off",t[t.Messages=1]="Messages",t[t.Compact=2]="Compact",t[t.Verbose=3]="Verbose"})(b||(h.Trace=b={}));var bn;(function(t){t.Off="off",t.Messages="messages",t.Compact="compact",t.Verbose="verbose"})(bn||(h.TraceValues=bn={}));(function(t){function e(n){if(!x.string(n))return t.Off;switch(n=n.toLowerCase(),n){case"off":return t.Off;case"messages":return t.Messages;case"compact":return t.Compact;case"verbose":return t.Verbose;default:return t.Off}}t.fromString=e;function r(n){switch(n){case t.Off:return"off";case t.Messages:return"messages";case t.Compact:return"compact";case t.Verbose:return"verbose";default:return"off"}}t.toString=r})(b||(h.Trace=b={}));var F;(function(t){t.Text="text",t.JSON="json"})(F||(h.TraceFormat=F={}));(function(t){function e(r){return x.string(r)?(r=r.toLowerCase(),r==="json"?t.JSON:t.Text):t.Text}t.fromString=e})(F||(h.TraceFormat=F={}));var yr;(function(t){t.type=new f.NotificationType("$/setTrace")})(yr||(h.SetTraceNotification=yr={}));var nt;(function(t){t.type=new f.NotificationType("$/logTrace")})(nt||(h.LogTraceNotification=nt={}));var De;(function(t){t[t.Closed=1]="Closed",t[t.Disposed=2]="Disposed",t[t.AlreadyListening=3]="AlreadyListening"})(De||(h.ConnectionErrors=De={}));var Me=class t extends Error{constructor(e,r){super(r),this.code=e,Object.setPrototypeOf(this,t.prototype)}};h.ConnectionError=Me;var br;(function(t){function e(r){let n=r;return n&&x.func(n.cancelUndispatched)}t.is=e})(br||(h.ConnectionStrategy=br={}));var st;(function(t){function e(r){let n=r;return n&&(n.kind===void 0||n.kind==="id")&&x.func(n.createCancellationTokenSource)&&(n.dispose===void 0||x.func(n.dispose))}t.is=e})(st||(h.IdCancellationReceiverStrategy=st={}));var wr;(function(t){function e(r){let n=r;return n&&n.kind==="request"&&x.func(n.createCancellationTokenSource)&&(n.dispose===void 0||x.func(n.dispose))}t.is=e})(wr||(h.RequestCancellationReceiverStrategy=wr={}));var it;(function(t){t.Message=Object.freeze({createCancellationTokenSource(r){return new hr.CancellationTokenSource}});function e(r){return st.is(r)||wr.is(r)}t.is=e})(it||(h.CancellationReceiverStrategy=it={}));var ot;(function(t){t.Message=Object.freeze({sendCancellation(r,n){return r.sendNotification(We.type,{id:n})},cleanup(r){}});function e(r){let n=r;return n&&x.func(n.sendCancellation)&&x.func(n.cleanup)}t.is=e})(ot||(h.CancellationSenderStrategy=ot={}));var at;(function(t){t.Message=Object.freeze({receiver:it.Message,sender:ot.Message});function e(r){let n=r;return n&&it.is(n.receiver)&&ot.is(n.sender)}t.is=e})(at||(h.CancellationStrategy=at={}));var ct;(function(t){function e(r){let n=r;return n&&x.func(n.handleMessage)}t.is=e})(ct||(h.MessageStrategy=ct={}));var wn;(function(t){function e(r){let n=r;return n&&(at.is(n.cancellationStrategy)||br.is(n.connectionStrategy)||ct.is(n.messageStrategy))}t.is=e})(wn||(h.ConnectionOptions=wn={}));var Z;(function(t){t[t.New=1]="New",t[t.Listening=2]="Listening",t[t.Closed=3]="Closed",t[t.Disposed=4]="Disposed"})(Z||(Z={}));function Ls(t,e,r,n){let i=r!==void 0?r:h.NullLogger,c=0,m=0,g=0,_="2.0",R,A=new Map,B,J=new Map,G=new Map,ne,Q=new yn.LinkedMap,K=new Map,se=new Set,U=new Map,w=b.Off,Y=F.Text,M,X=Z.New,ye=new Ae.Emitter,Ue=new Ae.Emitter,Fe=new Ae.Emitter,bt=new Ae.Emitter,Br=new Ae.Emitter,ie=n&&n.cancellationStrategy?n.cancellationStrategy:at.Message;function Hr(s){if(s===null)throw new Error("Can't send requests with id null since the response can't be correlated.");return"req-"+s.toString()}function Jn(s){return s===null?"res-unknown-"+(++g).toString():"res-"+s.toString()}function Gn(){return"not-"+(++m).toString()}function Qn(s,a){f.Message.isRequest(a)?s.set(Hr(a.id),a):f.Message.isResponse(a)?s.set(Jn(a.id),a):s.set(Gn(),a)}function Kn(s){}function Ur(){return X===Z.Listening}function Fr(){return X===Z.Closed}function be(){return X===Z.Disposed}function Vr(){(X===Z.New||X===Z.Listening)&&(X=Z.Closed,Ue.fire(void 0))}function Xn(s){ye.fire([s,void 0,void 0])}function Yn(s){ye.fire(s)}t.onClose(Vr),t.onError(Xn),e.onClose(Vr),e.onError(Yn);function Jr(){ne||Q.size===0||(ne=(0,gn.default)().timer.setImmediate(()=>{ne=void 0,Zn()}))}function Gr(s){f.Message.isRequest(s)?ts(s):f.Message.isNotification(s)?ns(s):f.Message.isResponse(s)?rs(s):ss(s)}function Zn(){if(Q.size===0)return;let s=Q.shift();try{let a=n?.messageStrategy;ct.is(a)?a.handleMessage(s,Gr):Gr(s)}finally{Jr()}}let es=s=>{try{if(f.Message.isNotification(s)&&s.method===We.type.method){let a=s.params.id,u=Hr(a),d=Q.get(u);if(f.Message.isRequest(d)){let k=n?.connectionStrategy,N=k&&k.cancelUndispatched?k.cancelUndispatched(d,Kn):void 0;if(N&&(N.error!==void 0||N.result!==void 0)){Q.delete(u),U.delete(a),N.id=d.id,Ve(N,s.method,Date.now()),e.write(N).catch(()=>i.error("Sending response for canceled message failed."));return}}let S=U.get(a);if(S!==void 0){S.cancel(),wt(s);return}else se.add(a)}Qn(Q,s)}finally{Jr()}};function ts(s){if(be())return;function a(y,T,v){let I={jsonrpc:_,id:s.id};y instanceof f.ResponseError?I.error=y.toJson():I.result=y===void 0?null:y,Ve(I,T,v),e.write(I).catch(()=>i.error("Sending response failed."))}function u(y,T,v){let I={jsonrpc:_,id:s.id,error:y.toJson()};Ve(I,T,v),e.write(I).catch(()=>i.error("Sending response failed."))}function d(y,T,v){y===void 0&&(y=null);let I={jsonrpc:_,id:s.id,result:y};Ve(I,T,v),e.write(I).catch(()=>i.error("Sending response failed."))}as(s);let S=A.get(s.method),k,N;S&&(k=S.type,N=S.handler);let O=Date.now();if(N||R){let y=s.id??String(Date.now()),T=st.is(ie.receiver)?ie.receiver.createCancellationTokenSource(y):ie.receiver.createCancellationTokenSource(s);s.id!==null&&se.has(s.id)&&T.cancel(),s.id!==null&&U.set(y,T);try{let v;if(N)if(s.params===void 0){if(k!==void 0&&k.numberOfParams!==0){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines ${k.numberOfParams} params but received none.`),s.method,O);return}v=N(T.token)}else if(Array.isArray(s.params)){if(k!==void 0&&k.parameterStructures===f.ParameterStructures.byName){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines parameters by name but received parameters by position`),s.method,O);return}v=N(...s.params,T.token)}else{if(k!==void 0&&k.parameterStructures===f.ParameterStructures.byPosition){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines parameters by position but received parameters by name`),s.method,O);return}v=N(s.params,T.token)}else R&&(v=R(s.method,s.params,T.token));let I=v;v?I.then?I.then(z=>{U.delete(y),a(z,s.method,O)},z=>{U.delete(y),z instanceof f.ResponseError?u(z,s.method,O):z&&x.string(z.message)?u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed with message: ${z.message}`),s.method,O):u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed unexpectedly without providing any details.`),s.method,O)}):(U.delete(y),a(v,s.method,O)):(U.delete(y),d(v,s.method,O))}catch(v){U.delete(y),v instanceof f.ResponseError?a(v,s.method,O):v&&x.string(v.message)?u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed with message: ${v.message}`),s.method,O):u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed unexpectedly without providing any details.`),s.method,O)}}else u(new f.ResponseError(f.ErrorCodes.MethodNotFound,`Unhandled method ${s.method}`),s.method,O)}function rs(s){if(!be())if(s.id===null)s.error?i.error(`Received response message without id: Error is: 
${JSON.stringify(s.error,void 0,4)}`):i.error("Received response message without id. No further error information provided.");else{let a=s.id,u=K.get(a);if(cs(s,u),u!==void 0){K.delete(a);try{if(s.error){let d=s.error;u.reject(new f.ResponseError(d.code,d.message,d.data))}else if(s.result!==void 0)u.resolve(s.result);else throw new Error("Should never happen.")}catch(d){d.message?i.error(`Response handler '${u.method}' failed with message: ${d.message}`):i.error(`Response handler '${u.method}' failed unexpectedly.`)}}}}function ns(s){if(be())return;let a,u;if(s.method===We.type.method){let d=s.params.id;se.delete(d),wt(s);return}else{let d=J.get(s.method);d&&(u=d.handler,a=d.type)}if(u||B)try{if(wt(s),u)if(s.params===void 0)a!==void 0&&a.numberOfParams!==0&&a.parameterStructures!==f.ParameterStructures.byName&&i.error(`Notification ${s.method} defines ${a.numberOfParams} params but received none.`),u();else if(Array.isArray(s.params)){let d=s.params;s.method===$e.type.method&&d.length===2&&mr.is(d[0])?u({token:d[0],value:d[1]}):(a!==void 0&&(a.parameterStructures===f.ParameterStructures.byName&&i.error(`Notification ${s.method} defines parameters by name but received parameters by position`),a.numberOfParams!==s.params.length&&i.error(`Notification ${s.method} defines ${a.numberOfParams} params but received ${d.length} arguments`)),u(...d))}else a!==void 0&&a.parameterStructures===f.ParameterStructures.byPosition&&i.error(`Notification ${s.method} defines parameters by position but received parameters by name`),u(s.params);else B&&B(s.method,s.params)}catch(d){d.message?i.error(`Notification handler '${s.method}' failed with message: ${d.message}`):i.error(`Notification handler '${s.method}' failed unexpectedly.`)}else Fe.fire(s)}function ss(s){if(!s){i.error("Received empty message.");return}i.error(`Received message which is neither a response nor a notification message:
${JSON.stringify(s,null,4)}`);let a=s;if(x.string(a.id)||x.number(a.id)){let u=a.id,d=K.get(u);d&&d.reject(new Error("The received response has neither a result nor an error property."))}}function oe(s){if(s!=null)switch(w){case b.Verbose:return JSON.stringify(s,null,4);case b.Compact:return JSON.stringify(s);default:return}}function is(s){if(!(w===b.Off||!M))if(Y===F.Text){let a;(w===b.Verbose||w===b.Compact)&&s.params&&(a=`Params: ${oe(s.params)}

`),M.log(`Sending request '${s.method} - (${s.id})'.`,a)}else we("send-request",s)}function os(s){if(!(w===b.Off||!M))if(Y===F.Text){let a;(w===b.Verbose||w===b.Compact)&&(s.params?a=`Params: ${oe(s.params)}

`:a=`No parameters provided.

`),M.log(`Sending notification '${s.method}'.`,a)}else we("send-notification",s)}function Ve(s,a,u){if(!(w===b.Off||!M))if(Y===F.Text){let d;(w===b.Verbose||w===b.Compact)&&(s.error&&s.error.data?d=`Error data: ${oe(s.error.data)}

`:s.result?d=`Result: ${oe(s.result)}

`:s.error===void 0&&(d=`No result returned.

`)),M.log(`Sending response '${a} - (${s.id})'. Processing request took ${Date.now()-u}ms`,d)}else we("send-response",s)}function as(s){if(!(w===b.Off||!M))if(Y===F.Text){let a;(w===b.Verbose||w===b.Compact)&&s.params&&(a=`Params: ${oe(s.params)}

`),M.log(`Received request '${s.method} - (${s.id})'.`,a)}else we("receive-request",s)}function wt(s){if(!(w===b.Off||!M||s.method===nt.type.method))if(Y===F.Text){let a;(w===b.Verbose||w===b.Compact)&&(s.params?a=`Params: ${oe(s.params)}

`:a=`No parameters provided.

`),M.log(`Received notification '${s.method}'.`,a)}else we("receive-notification",s)}function cs(s,a){if(!(w===b.Off||!M))if(Y===F.Text){let u;if((w===b.Verbose||w===b.Compact)&&(s.error&&s.error.data?u=`Error data: ${oe(s.error.data)}

`:s.result?u=`Result: ${oe(s.result)}

`:s.error===void 0&&(u=`No result returned.

`)),a){let d=s.error?` Request failed: ${s.error.message} (${s.error.code}).`:"";M.log(`Received response '${a.method} - (${s.id})' in ${Date.now()-a.timerStart}ms.${d}`,u)}else M.log(`Received response ${s.id} without active response promise.`,u)}else we("receive-response",s)}function we(s,a){if(!M||w===b.Off)return;let u={isLSPMessage:!0,type:s,message:a,timestamp:Date.now()};M.log(u)}function Ie(){if(Fr())throw new Me(De.Closed,"Connection is closed.");if(be())throw new Me(De.Disposed,"Connection is disposed.")}function us(){if(Ur())throw new Me(De.AlreadyListening,"Connection is already listening")}function ds(){if(!Ur())throw new Error("Call listen() first.")}function je(s){return s===void 0?null:s}function Qr(s){if(s!==null)return s}function Kr(s){return s!=null&&!Array.isArray(s)&&typeof s=="object"}function vt(s,a){switch(s){case f.ParameterStructures.auto:return Kr(a)?Qr(a):[je(a)];case f.ParameterStructures.byName:if(!Kr(a))throw new Error("Received parameters by name but param is not an object literal.");return Qr(a);case f.ParameterStructures.byPosition:return[je(a)];default:throw new Error(`Unknown parameter structure ${s.toString()}`)}}function Xr(s,a){let u,d=s.numberOfParams;switch(d){case 0:u=void 0;break;case 1:u=vt(s.parameterStructures,a[0]);break;default:u=[];for(let S=0;S<a.length&&S<d;S++)u.push(je(a[S]));if(a.length<d)for(let S=a.length;S<d;S++)u.push(null);break}return u}let ve={sendNotification:(s,...a)=>{Ie();let u,d;if(x.string(s)){u=s;let k=a[0],N=0,O=f.ParameterStructures.auto;f.ParameterStructures.is(k)&&(N=1,O=k);let y=a.length,T=y-N;switch(T){case 0:d=void 0;break;case 1:d=vt(O,a[N]);break;default:if(O===f.ParameterStructures.byName)throw new Error(`Received ${T} parameters for 'by Name' notification parameter structure.`);d=a.slice(N,y).map(v=>je(v));break}}else{let k=a;u=s.method,d=Xr(s,k)}let S={jsonrpc:_,method:u,params:d};return os(S),e.write(S).catch(k=>{throw i.error("Sending notification failed."),k})},onNotification:(s,a)=>{Ie();let u;return x.func(s)?B=s:a&&(x.string(s)?(u=s,J.set(s,{type:void 0,handler:a})):(u=s.method,J.set(s.method,{type:s,handler:a}))),{dispose:()=>{u!==void 0?J.delete(u):B=void 0}}},onProgress:(s,a,u)=>{if(G.has(a))throw new Error(`Progress handler for token ${a} already registered`);return G.set(a,u),{dispose:()=>{G.delete(a)}}},sendProgress:(s,a,u)=>ve.sendNotification($e.type,{token:a,value:u}),onUnhandledProgress:bt.event,sendRequest:(s,...a)=>{Ie(),ds();let u,d,S;if(x.string(s)){u=s;let y=a[0],T=a[a.length-1],v=0,I=f.ParameterStructures.auto;f.ParameterStructures.is(y)&&(v=1,I=y);let z=a.length;hr.CancellationToken.is(T)&&(z=z-1,S=T);let te=z-v;switch(te){case 0:d=void 0;break;case 1:d=vt(I,a[v]);break;default:if(I===f.ParameterStructures.byName)throw new Error(`Received ${te} parameters for 'by Name' request parameter structure.`);d=a.slice(v,z).map(ls=>je(ls));break}}else{let y=a;u=s.method,d=Xr(s,y);let T=s.numberOfParams;S=hr.CancellationToken.is(y[T])?y[T]:void 0}let k=c++,N;S&&(N=S.onCancellationRequested(()=>{let y=ie.sender.sendCancellation(ve,k);return y===void 0?(i.log(`Received no promise from cancellation strategy when cancelling id ${k}`),Promise.resolve()):y.catch(()=>{i.log(`Sending cancellation messages for id ${k} failed`)})}));let O={jsonrpc:_,id:k,method:u,params:d};return is(O),typeof ie.sender.enableCancellation=="function"&&ie.sender.enableCancellation(O),new Promise(async(y,T)=>{let v=te=>{y(te),ie.sender.cleanup(k),N?.dispose()},I=te=>{T(te),ie.sender.cleanup(k),N?.dispose()},z={method:u,timerStart:Date.now(),resolve:v,reject:I};try{K.set(k,z),await e.write(O)}catch(te){throw K.delete(k),z.reject(new f.ResponseError(f.ErrorCodes.MessageWriteError,te.message?te.message:"Unknown reason")),i.error("Sending request failed."),te}})},onRequest:(s,a)=>{Ie();let u=null;return gr.is(s)?(u=void 0,R=s):x.string(s)?(u=null,a!==void 0&&(u=s,A.set(s,{handler:a,type:void 0}))):a!==void 0&&(u=s.method,A.set(s.method,{type:s,handler:a})),{dispose:()=>{u!==null&&(u!==void 0?A.delete(u):R=void 0)}}},hasPendingResponse:()=>K.size>0,trace:async(s,a,u)=>{let d=!1,S=F.Text;u!==void 0&&(x.boolean(u)?d=u:(d=u.sendNotification||!1,S=u.traceFormat||F.Text)),w=s,Y=S,w===b.Off?M=void 0:M=a,d&&!Fr()&&!be()&&await ve.sendNotification(yr.type,{value:b.toString(s)})},onError:ye.event,onClose:Ue.event,onUnhandledNotification:Fe.event,onDispose:Br.event,end:()=>{e.end()},dispose:()=>{if(be())return;X=Z.Disposed,Br.fire(void 0);let s=new f.ResponseError(f.ErrorCodes.PendingResponseRejected,"Pending response rejected since connection got disposed");for(let a of K.values())a.reject(s);K=new Map,U=new Map,se=new Set,Q=new yn.LinkedMap,x.func(e.dispose)&&e.dispose(),x.func(t.dispose)&&t.dispose()},listen:()=>{Ie(),us(),X=Z.Listening,t.listen(es)},inspect:()=>{(0,gn.default)().console.log("inspect")}};return ve.onNotification(nt.type,s=>{if(w===b.Off||!M)return;let a=w===b.Verbose||w===b.Compact;M.log(s.message,a?s.verbose:void 0)}),ve.onNotification($e.type,s=>{let a=G.get(s.token);a?a(s.value):bt.fire(s)}),ve}h.createMessageConnection=Ls});var ut=q(o=>{"use strict";Object.defineProperty(o,"__esModule",{value:!0});o.ProgressType=o.ProgressToken=o.createMessageConnection=o.NullLogger=o.ConnectionOptions=o.ConnectionStrategy=o.AbstractMessageBuffer=o.WriteableStreamMessageWriter=o.AbstractMessageWriter=o.MessageWriter=o.ReadableStreamMessageReader=o.AbstractMessageReader=o.MessageReader=o.SharedArrayReceiverStrategy=o.SharedArraySenderStrategy=o.CancellationToken=o.CancellationTokenSource=o.Emitter=o.Event=o.Disposable=o.LRUCache=o.Touch=o.LinkedMap=o.ParameterStructures=o.NotificationType9=o.NotificationType8=o.NotificationType7=o.NotificationType6=o.NotificationType5=o.NotificationType4=o.NotificationType3=o.NotificationType2=o.NotificationType1=o.NotificationType0=o.NotificationType=o.ErrorCodes=o.ResponseError=o.RequestType9=o.RequestType8=o.RequestType7=o.RequestType6=o.RequestType5=o.RequestType4=o.RequestType3=o.RequestType2=o.RequestType1=o.RequestType0=o.RequestType=o.Message=o.RAL=void 0;o.MessageStrategy=o.CancellationStrategy=o.CancellationSenderStrategy=o.CancellationReceiverStrategy=o.ConnectionError=o.ConnectionErrors=o.LogTraceNotification=o.SetTraceNotification=o.TraceFormat=o.TraceValues=o.Trace=void 0;var P=Ft();Object.defineProperty(o,"Message",{enumerable:!0,get:function(){return P.Message}});Object.defineProperty(o,"RequestType",{enumerable:!0,get:function(){return P.RequestType}});Object.defineProperty(o,"RequestType0",{enumerable:!0,get:function(){return P.RequestType0}});Object.defineProperty(o,"RequestType1",{enumerable:!0,get:function(){return P.RequestType1}});Object.defineProperty(o,"RequestType2",{enumerable:!0,get:function(){return P.RequestType2}});Object.defineProperty(o,"RequestType3",{enumerable:!0,get:function(){return P.RequestType3}});Object.defineProperty(o,"RequestType4",{enumerable:!0,get:function(){return P.RequestType4}});Object.defineProperty(o,"RequestType5",{enumerable:!0,get:function(){return P.RequestType5}});Object.defineProperty(o,"RequestType6",{enumerable:!0,get:function(){return P.RequestType6}});Object.defineProperty(o,"RequestType7",{enumerable:!0,get:function(){return P.RequestType7}});Object.defineProperty(o,"RequestType8",{enumerable:!0,get:function(){return P.RequestType8}});Object.defineProperty(o,"RequestType9",{enumerable:!0,get:function(){return P.RequestType9}});Object.defineProperty(o,"ResponseError",{enumerable:!0,get:function(){return P.ResponseError}});Object.defineProperty(o,"ErrorCodes",{enumerable:!0,get:function(){return P.ErrorCodes}});Object.defineProperty(o,"NotificationType",{enumerable:!0,get:function(){return P.NotificationType}});Object.defineProperty(o,"NotificationType0",{enumerable:!0,get:function(){return P.NotificationType0}});Object.defineProperty(o,"NotificationType1",{enumerable:!0,get:function(){return P.NotificationType1}});Object.defineProperty(o,"NotificationType2",{enumerable:!0,get:function(){return P.NotificationType2}});Object.defineProperty(o,"NotificationType3",{enumerable:!0,get:function(){return P.NotificationType3}});Object.defineProperty(o,"NotificationType4",{enumerable:!0,get:function(){return P.NotificationType4}});Object.defineProperty(o,"NotificationType5",{enumerable:!0,get:function(){return P.NotificationType5}});Object.defineProperty(o,"NotificationType6",{enumerable:!0,get:function(){return P.NotificationType6}});Object.defineProperty(o,"NotificationType7",{enumerable:!0,get:function(){return P.NotificationType7}});Object.defineProperty(o,"NotificationType8",{enumerable:!0,get:function(){return P.NotificationType8}});Object.defineProperty(o,"NotificationType9",{enumerable:!0,get:function(){return P.NotificationType9}});Object.defineProperty(o,"ParameterStructures",{enumerable:!0,get:function(){return P.ParameterStructures}});var vr=Jt();Object.defineProperty(o,"LinkedMap",{enumerable:!0,get:function(){return vr.LinkedMap}});Object.defineProperty(o,"LRUCache",{enumerable:!0,get:function(){return vr.LRUCache}});Object.defineProperty(o,"Touch",{enumerable:!0,get:function(){return vr.Touch}});var As=sn();Object.defineProperty(o,"Disposable",{enumerable:!0,get:function(){return As.Disposable}});var kn=_e();Object.defineProperty(o,"Event",{enumerable:!0,get:function(){return kn.Event}});Object.defineProperty(o,"Emitter",{enumerable:!0,get:function(){return kn.Emitter}});var Pn=Ye();Object.defineProperty(o,"CancellationTokenSource",{enumerable:!0,get:function(){return Pn.CancellationTokenSource}});Object.defineProperty(o,"CancellationToken",{enumerable:!0,get:function(){return Pn.CancellationToken}});var _n=an();Object.defineProperty(o,"SharedArraySenderStrategy",{enumerable:!0,get:function(){return _n.SharedArraySenderStrategy}});Object.defineProperty(o,"SharedArrayReceiverStrategy",{enumerable:!0,get:function(){return _n.SharedArrayReceiverStrategy}});var kr=un();Object.defineProperty(o,"MessageReader",{enumerable:!0,get:function(){return kr.MessageReader}});Object.defineProperty(o,"AbstractMessageReader",{enumerable:!0,get:function(){return kr.AbstractMessageReader}});Object.defineProperty(o,"ReadableStreamMessageReader",{enumerable:!0,get:function(){return kr.ReadableStreamMessageReader}});var Pr=mn();Object.defineProperty(o,"MessageWriter",{enumerable:!0,get:function(){return Pr.MessageWriter}});Object.defineProperty(o,"AbstractMessageWriter",{enumerable:!0,get:function(){return Pr.AbstractMessageWriter}});Object.defineProperty(o,"WriteableStreamMessageWriter",{enumerable:!0,get:function(){return Pr.WriteableStreamMessageWriter}});var $s=pn();Object.defineProperty(o,"AbstractMessageBuffer",{enumerable:!0,get:function(){return $s.AbstractMessageBuffer}});var L=vn();Object.defineProperty(o,"ConnectionStrategy",{enumerable:!0,get:function(){return L.ConnectionStrategy}});Object.defineProperty(o,"ConnectionOptions",{enumerable:!0,get:function(){return L.ConnectionOptions}});Object.defineProperty(o,"NullLogger",{enumerable:!0,get:function(){return L.NullLogger}});Object.defineProperty(o,"createMessageConnection",{enumerable:!0,get:function(){return L.createMessageConnection}});Object.defineProperty(o,"ProgressToken",{enumerable:!0,get:function(){return L.ProgressToken}});Object.defineProperty(o,"ProgressType",{enumerable:!0,get:function(){return L.ProgressType}});Object.defineProperty(o,"Trace",{enumerable:!0,get:function(){return L.Trace}});Object.defineProperty(o,"TraceValues",{enumerable:!0,get:function(){return L.TraceValues}});Object.defineProperty(o,"TraceFormat",{enumerable:!0,get:function(){return L.TraceFormat}});Object.defineProperty(o,"SetTraceNotification",{enumerable:!0,get:function(){return L.SetTraceNotification}});Object.defineProperty(o,"LogTraceNotification",{enumerable:!0,get:function(){return L.LogTraceNotification}});Object.defineProperty(o,"ConnectionErrors",{enumerable:!0,get:function(){return L.ConnectionErrors}});Object.defineProperty(o,"ConnectionError",{enumerable:!0,get:function(){return L.ConnectionError}});Object.defineProperty(o,"CancellationReceiverStrategy",{enumerable:!0,get:function(){return L.CancellationReceiverStrategy}});Object.defineProperty(o,"CancellationSenderStrategy",{enumerable:!0,get:function(){return L.CancellationSenderStrategy}});Object.defineProperty(o,"CancellationStrategy",{enumerable:!0,get:function(){return L.CancellationStrategy}});Object.defineProperty(o,"MessageStrategy",{enumerable:!0,get:function(){return L.MessageStrategy}});var Ds=ce();o.RAL=Ds.default});var En=q(Er=>{"use strict";Object.defineProperty(Er,"__esModule",{value:!0});var Rn=require("util"),re=ut(),dt=class t extends re.AbstractMessageBuffer{constructor(e="utf-8"){super(e)}emptyBuffer(){return t.emptyBuffer}fromString(e,r){return Buffer.from(e,r)}toString(e,r){return e instanceof Buffer?e.toString(r):new Rn.TextDecoder(r).decode(e)}asNative(e,r){return r===void 0?e instanceof Buffer?e:Buffer.from(e):e instanceof Buffer?e.slice(0,r):Buffer.from(e,0,r)}allocNative(e){return Buffer.allocUnsafe(e)}};dt.emptyBuffer=Buffer.allocUnsafe(0);var _r=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),re.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),re.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),re.Disposable.create(()=>this.stream.off("end",e))}onData(e){return this.stream.on("data",e),re.Disposable.create(()=>this.stream.off("data",e))}},Rr=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),re.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),re.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),re.Disposable.create(()=>this.stream.off("end",e))}write(e,r){return new Promise((n,i)=>{let c=m=>{m==null?n():i(m)};typeof e=="string"?this.stream.write(e,r,c):this.stream.write(e,c)})}end(){this.stream.end()}},Sn=Object.freeze({messageBuffer:Object.freeze({create:t=>new dt(t)}),applicationJson:Object.freeze({encoder:Object.freeze({name:"application/json",encode:(t,e)=>{try{return Promise.resolve(Buffer.from(JSON.stringify(t,void 0,0),e.charset))}catch(r){return Promise.reject(r)}}}),decoder:Object.freeze({name:"application/json",decode:(t,e)=>{try{return t instanceof Buffer?Promise.resolve(JSON.parse(t.toString(e.charset))):Promise.resolve(JSON.parse(new Rn.TextDecoder(e.charset).decode(t)))}catch(r){return Promise.reject(r)}}})}),stream:Object.freeze({asReadableStream:t=>new _r(t),asWritableStream:t=>new Rr(t)}),console,timer:Object.freeze({setTimeout(t,e,...r){let n=setTimeout(t,e,...r);return{dispose:()=>clearTimeout(n)}},setImmediate(t,...e){let r=setImmediate(t,...e);return{dispose:()=>clearImmediate(r)}},setInterval(t,e,...r){let n=setInterval(t,e,...r);return{dispose:()=>clearInterval(n)}}})});function Sr(){return Sn}(function(t){function e(){re.RAL.install(Sn)}t.install=e})(Sr||(Sr={}));Er.default=Sr});var xn=q(p=>{"use strict";var Ws=p&&p.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),zs=p&&p.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Ws(e,t,r)};Object.defineProperty(p,"__esModule",{value:!0});p.createMessageConnection=p.createServerSocketTransport=p.createClientSocketTransport=p.createServerPipeTransport=p.createClientPipeTransport=p.generateRandomPipeName=p.StreamMessageWriter=p.StreamMessageReader=p.SocketMessageWriter=p.SocketMessageReader=p.PortMessageWriter=p.PortMessageReader=p.IPCMessageWriter=p.IPCMessageReader=void 0;var Te=En();Te.default.install();var Mn=require("path"),Bs=require("os"),Hs=require("crypto"),ht=require("net"),V=ut();zs(ut(),p);var Mr=class extends V.AbstractMessageReader{constructor(e){super(),this.process=e;let r=this.process;r.on("error",n=>this.fireError(n)),r.on("close",()=>this.fireClose())}listen(e){return this.process.on("message",e),V.Disposable.create(()=>this.process.off("message",e))}};p.IPCMessageReader=Mr;var Tr=class extends V.AbstractMessageWriter{constructor(e){super(),this.process=e,this.errorCount=0;let r=this.process;r.on("error",n=>this.fireError(n)),r.on("close",()=>this.fireClose)}write(e){try{return typeof this.process.send=="function"&&this.process.send(e,void 0,void 0,r=>{r?(this.errorCount++,this.handleError(r,e)):this.errorCount=0}),Promise.resolve()}catch(r){return this.handleError(r,e),Promise.reject(r)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){}};p.IPCMessageWriter=Tr;var xr=class extends V.AbstractMessageReader{constructor(e){super(),this.onData=new V.Emitter,e.on("close",()=>this.fireClose),e.on("error",r=>this.fireError(r)),e.on("message",r=>{this.onData.fire(r)})}listen(e){return this.onData.event(e)}};p.PortMessageReader=xr;var Nr=class extends V.AbstractMessageWriter{constructor(e){super(),this.port=e,this.errorCount=0,e.on("close",()=>this.fireClose()),e.on("error",r=>this.fireError(r))}write(e){try{return this.port.postMessage(e),Promise.resolve()}catch(r){return this.handleError(r,e),Promise.reject(r)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){}};p.PortMessageWriter=Nr;var me=class extends V.ReadableStreamMessageReader{constructor(e,r="utf-8"){super((0,Te.default)().stream.asReadableStream(e),r)}};p.SocketMessageReader=me;var pe=class extends V.WriteableStreamMessageWriter{constructor(e,r){super((0,Te.default)().stream.asWritableStream(e),r),this.socket=e}dispose(){super.dispose(),this.socket.destroy()}};p.SocketMessageWriter=pe;var lt=class extends V.ReadableStreamMessageReader{constructor(e,r){super((0,Te.default)().stream.asReadableStream(e),r)}};p.StreamMessageReader=lt;var ft=class extends V.WriteableStreamMessageWriter{constructor(e,r){super((0,Te.default)().stream.asWritableStream(e),r)}};p.StreamMessageWriter=ft;var Tn=process.env.XDG_RUNTIME_DIR,Us=new Map([["linux",107],["darwin",103]]);function Fs(){let t=(0,Hs.randomBytes)(21).toString("hex");if(process.platform==="win32")return`\\\\.\\pipe\\vscode-jsonrpc-${t}-sock`;let e;Tn?e=Mn.join(Tn,`vscode-ipc-${t}.sock`):e=Mn.join(Bs.tmpdir(),`vscode-${t}.sock`);let r=Us.get(process.platform);return r!==void 0&&e.length>r&&(0,Te.default)().console.warn(`WARNING: IPC handle "${e}" is longer than ${r} characters.`),e}p.generateRandomPipeName=Fs;function Vs(t,e="utf-8"){let r,n=new Promise((i,c)=>{r=i});return new Promise((i,c)=>{let m=(0,ht.createServer)(g=>{m.close(),r([new me(g,e),new pe(g,e)])});m.on("error",c),m.listen(t,()=>{m.removeListener("error",c),i({onConnected:()=>n})})})}p.createClientPipeTransport=Vs;function Js(t,e="utf-8"){let r=(0,ht.createConnection)(t);return[new me(r,e),new pe(r,e)]}p.createServerPipeTransport=Js;function Gs(t,e="utf-8"){let r,n=new Promise((i,c)=>{r=i});return new Promise((i,c)=>{let m=(0,ht.createServer)(g=>{m.close(),r([new me(g,e),new pe(g,e)])});m.on("error",c),m.listen(t,"127.0.0.1",()=>{m.removeListener("error",c),i({onConnected:()=>n})})})}p.createClientSocketTransport=Gs;function Qs(t,e="utf-8"){let r=(0,ht.createConnection)(t,"127.0.0.1");return[new me(r,e),new pe(r,e)]}p.createServerSocketTransport=Qs;function Ks(t){let e=t;return e.read!==void 0&&e.addListener!==void 0}function Xs(t){let e=t;return e.write!==void 0&&e.addListener!==void 0}function Ys(t,e,r,n){r||(r=V.NullLogger);let i=Ks(t)?new lt(t):t,c=Xs(e)?new ft(e):e;return V.ConnectionStrategy.is(n)&&(n={connectionStrategy:n}),(0,V.createMessageConnection)(i,c,r,n)}p.createMessageConnection=Ys});var On=q((vi,Nn)=>{"use strict";Nn.exports=xn()});var Fn=require("util");var Oe=bs(On());var Cn=require("node:worker_threads");var C=class t extends Error{underlying;get name(){return this.underlying instanceof Error?this.underlying.name:typeof this.underlying=="string"||this.underlying instanceof String?`${this.underlying}`:JSON.stringify(this.underlying)}code;title;breadcrumbs;diagnostics;sessionId;constructor(e,r,n,i){e&&typeof e=="object"&&"message"in e&&typeof e.message=="string"?super(e.message):i?.message?super(i?.message):typeof e=="string"?super(e):super(),this.underlying=e,this.code=r,this.title=n,this.stack=e instanceof Error?e.stack:i?.stack,this.breadcrumbs=i?.breadcrumbs,this.diagnostics=i?.diagnostics,this.sessionId=i?.sessionId??Cn.workerData?.sessionId}serialize(){return{_isRayError:!0,code:this.code,title:this.title,name:this.name,message:this.message,stack:this.stack,breadcrumbs:this.breadcrumbs,diagnostics:this.diagnostics,sessionId:this.sessionId}}static tryDeserialize(e){if(!t.isRecord(e)||!t.hasProperty(e,"_isRayError")||!e._isRayError||Array.isArray(e)||!t.hasProperty(e,"code")||typeof e.code!="number"||!t.hasProperty(e,"title")||typeof e.title!="string"||!t.hasProperty(e,"name")||typeof e.name!="string")return null;let r=t.hasProperty(e,"message")&&typeof e.message=="string"?e.message:void 0,n=t.hasProperty(e,"stack")&&typeof e.stack=="string"?e.stack:void 0,i=t.hasProperty(e,"breadcrumbs")&&Array.isArray(e.breadcrumbs)?e.breadcrumbs:void 0,c=t.hasProperty(e,"diagnostics")&&typeof e.diagnostics=="object"?e.diagnostics:void 0,m=t.hasProperty(e,"sessionId")&&typeof e.sessionId=="string"?e.sessionId:void 0;return new t(e.name,e.code,e.title,{message:r,stack:n,breadcrumbs:i,diagnostics:c,sessionId:m})}static hasProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)&&typeof e[r]<"u"&&e[r]!==null}static isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}};function In(t){return t.replace(/(\\ud800|\ud800|\0)/gi,"")}var Or;if(process.env.RAYCAST_OS_LOG!==void 0){let{NapiOsLog:t}=require("@raycast/napi");Or=new t(process.env.RAYCAST_BUNDLE_ID,"node")}else Or={log:(t,e)=>{}};function Cr(t,e){Or.log(t,e)}function W(t){Cr(1,t)}function jn(t){Cr(2,t)}function j(t){Cr(16,t)}var Be=require("node:perf_hooks");var Ln=require("worker_threads");var Zs=[];function mt(){return Zs}var Ir=require("node:crypto"),ei="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",ti=128,ge,xe;function ri(t){!ge||ge.length<t?(ge=Buffer.allocUnsafe(t*ti),Ir.webcrypto.getRandomValues(ge),xe=0):xe+t>ge.length&&(Ir.webcrypto.getRandomValues(ge),xe=0),xe+=t}function qn(t=21){ri(t-=0);let e="";for(let r=xe-t;r<xe;r++)e+=ei[ge[r]&63];return e}var pt=class{options;terminationHandler;worker;resultHandlers;timeoutId;lastELU;isHandlingError=!1;get id(){return this.options.id}constructor(e,r){this.options=e,this.terminationHandler=r,this.resultHandlers=new Map,this.worker=new Ln.Worker(e.workerPath,{workerData:e,stdin:!0,stdout:!0,stderr:!0,resourceLimits:{maxOldGenerationSizeMb:e.maxHeapSizeMb}}),e.timeout&&(this.timeoutId=setTimeout(this.timeout.bind(this),e.timeout*1e3))}load(){return this.worker.on("message",async e=>{let{kind:r}=e;switch(r){case"notify":{let{method:n}=e,{params:i}=e;switch(n){case"commandException":{this.isHandlingError=!0;let c=C.tryDeserialize(i)??new C(i,6,"Worker Error",{sessionId:this.id});c.diagnostics||(c.diagnostics=this.diagnostics()),await ze(c);break}case"captureException":{let c=C.tryDeserialize(i)??new C(i,6,"Worker Error",{sessionId:this.id});c.diagnostics||(c.diagnostics=this.diagnostics()),$n(c);break}default:{le(n,i);break}}}break;case"request":{let{id:n}=e;try{let{method:i}=e,{params:c}=e,m=await An(i,{...c,sessionId:this.id,requestId:n});this.worker.postMessage({kind:"result",id:n,result:{success:!0,value:m}})}catch(i){this.worker.postMessage({kind:"result",id:n,result:{success:!1,error:i}})}}break;case"result":{let{id:n}=e,{result:i}=e;this.resultHandlers.get(n)?.(i),this.resultHandlers.delete(n)}break;default:break}}),this.worker.on("messageerror",async e=>{this.isHandlingError=!0,j(`Worker (${this.id}) message error: ${e}`);let r=new C(e,5,"Worker Message Error",{breadcrumbs:mt(),diagnostics:this.diagnostics(),sessionId:this.id});await ze(r)}),this.worker.on("error",async e=>{this.isHandlingError=!0,j(`Worker (${this.id}) error: ${e}`);let r=new C(e,6,"Worker Error",{breadcrumbs:mt(),diagnostics:this.diagnostics(),sessionId:this.id});await ze(r)}),this.worker.on("exit",e=>{W(`Worker (${this.id}) exit: ${e}`),this.removeListeners(),this.terminationHandler?.(this.id),!this.isHandlingError&&le("commandExited",{sessionId:this.id,code:e})}),this.request("initialize",{})}async unload(){try{return await this.worker.terminate()}finally{this.removeListeners()}}request(e,r){return new Promise((n,i)=>{let c=qn(),m=g=>{if(g.success===!1){j(`Worker (${this.id}) request error: ${JSON.stringify(g.error)}`);let _=C.tryDeserialize(g.error)??new C(g.error,8,"Worker Request Error");_.sessionId||(_.sessionId=this.id),_.diagnostics||(_.diagnostics=this.diagnostics()),i(_.serialize());return}n(g.value)};this.resultHandlers.set(c,m),this.worker.postMessage({kind:"request",id:c,method:e,params:r})})}diagnostics(){let e=this.worker.performance.eventLoopUtilization(),r=this.worker.performance.eventLoopUtilization(e,this.lastELU);return this.lastELU=e,{id:this.options.id,extensionName:this.options.extensionName,name:this.options.entryPointName,mode:this.options.entryPointMode,isDevelopment:this.options.isDevelopment,launchType:this.options.launchType,timeout:this.options.timeout,eventLoopUtilization:r,startedAt:this.options.startedAt}}async timeout(){try{this.worker.removeAllListeners("exit"),await this.worker.terminate()}catch(e){j(`Worker (${this.id}) timeout error: ${e}`),await ze(new C(e,14,"Worker Timeout Error",{breadcrumbs:mt(),diagnostics:this.diagnostics(),sessionId:this.id}))}finally{this.removeListeners(),this.terminationHandler?.(this.id)}}removeListeners(){this.worker.removeAllListeners("message"),this.worker.removeAllListeners("messageerror"),this.worker.removeAllListeners("error"),this.worker.removeAllListeners("exit"),this.timeoutId&&clearTimeout(this.timeoutId)}};var fe=new Map,Ne=new Set;async function gt(t){Ne.delete(t.id);let e=new pt(t,r=>{fe.delete(r),Ne.add(r),setTimeout(()=>{Ne.delete(t.id)},1e3)});return fe.set(t.id,e),W(`Worker (${t.id}) loading, num workers: ${fe.size}`),e.load()}async function Dn(t){let e=fe.get(t);if(e)try{return await e.unload()}finally{fe.delete(t),Ne.add(t),setTimeout(()=>{Ne.delete(t)},1e3),W(`Worker (${t}) unloaded, num workers: ${fe.size}`)}}async function Wn(t,e,r){if(Ne.has(t))throw new C(new Error("Worker already terminated"),17,"Race Condition Error",{breadcrumbs:[{level:"fatal",category:"Request",message:"Worker already terminated",timestamp:new Date(Be.performance.timeOrigin+Be.performance.now()).toISOString(),data:{method:e,sessionId:t}}],sessionId:t}).serialize();let n=fe.get(t);if(!n)throw jn(`Worker session unknown: ${t}`),new C(new Error("Could not communicate with worker"),11,"Unknown Command",{breadcrumbs:[{level:"fatal",category:"Request",message:"Could not communicate with worker",timestamp:new Date(Be.performance.timeOrigin+Be.performance.now()).toISOString(),data:{method:e,sessionId:t}}],sessionId:t}).serialize();return n.request(e,r)}function zn(){return[...fe.values()].map(t=>t.diagnostics())}async function qr(t){return{workerDiagnostics:zn()}}async function Lr(t){return{nodeVersion:process.version}}async function Ar(t){let e=t?.sessionId,r=t?.workerPath,n=t?.ownerOrAuthorName,i=t?.extensionName,c=t?.commandName,m=t?.commandMode,g=t?.commandPath,_=t?.assetsPath,R=t?.supportPath,A=t?.maxHeapSizeMb,B=t?.isDevelopment,J=t?.appearance,G=t?.textSize,ne=t?.draftValues,Q=t?.launchType,K=t?.timeout,se=t?.startedAt;if(!e||!r||typeof n>"u"||!i||!c||!m||!g||!_||!R||!A||!J||!G||!Q)return j("Invalid parameters (load command)"),Promise.reject(new Error(`Invalid parameters ${t}`));let U=t?.preferences,w=t?.arguments,Y=t?.launchContext,M=t?.fallbackText,X=t?.canAccessAI,ye=t?.canAccessBetterAIModels,Ue=t?.isBrowserExtensionInstalled,Fe=t?.canAccessWindowManagement;return await gt({entryPointType:"command",id:e,workerPath:r,ownerOrAuthorName:n,extensionName:i,entryPointName:c,entryPointMode:m,commandPath:g,assetsPath:_,supportPath:R,preferences:U,maxHeapSizeMb:A,isDevelopment:B,appearance:J,textSize:G,draftValues:ne,argumentValues:w,launchType:Q,timeout:K,startedAt:se,launchContext:Y,fallbackText:M,canAccessAI:X,canAccessBetterAIModels:ye,isBrowserExtensionInstalled:Ue,canAccessWindowManagement:Fe})}async function $r(t){let e=t?.sessionId,r=t?.workerPath,n=t?.ownerOrAuthorName,i=t?.extensionName,c=t?.toolName,m=t?.toolMode,g=t?.toolPath,_=t?.shouldExecuteFunctionsBeforeReturning,R=t?.assetsPath,A=t?.supportPath,B=t?.maxHeapSizeMb,J=t?.isDevelopment,G=t?.appearance,ne=t?.textSize,Q=t?.timeout,K=t?.startedAt;if(!e||!r||typeof n>"u"||!i||!R||!A||!B||!G||!ne)return j("Invalid parameters (load tool)"),Promise.reject(new Error(`Invalid parameters ${t}`));let se=t?.preferences,U=t?.canAccessAI,w=t?.canAccessBetterAIModels,Y=t?.isBrowserExtensionInstalled,M=t?.canAccessWindowManagement,X=t?.arguments;return await gt({entryPointType:"tool",id:e,workerPath:r,ownerOrAuthorName:n,extensionName:i,entryPointName:c,entryPointMode:m,toolPath:g,shouldExecuteFunctionsBeforeReturning:_,assetsPath:R,supportPath:A,preferences:se,maxHeapSizeMb:B,isDevelopment:J,appearance:G,textSize:ne,timeout:Q,startedAt:K,canAccessAI:U,canAccessBetterAIModels:w,isBrowserExtensionInstalled:Y,canAccessWindowManagement:M,launchType:"userInitiated",arguments:X})}async function Dr(t){let e=t?.sessionId;if(!e)throw j(`Session ID missing from parameters (native callback): ${JSON.stringify(t)}`),new C("Native callback called without a session ID ",7,"Invalid Parameters").serialize();return await Wn(e,"nativeCallback",t)}async function Wr(t){let e=t?.sessionId;return e?await Dn(e):(j("Invalid parameters (unload entry point)"),Promise.reject(new Error("Invalid parameters")))}var Bn=require("node:worker_threads"),Hn=require("node:path"),ee=Oe.createMessageConnection(new Oe.StreamMessageReader(process.stdin),new Oe.StreamMessageWriter(process.stdout));ee.onRequest("initialize",t=>(W(`Server connection initialize: ${process.env.NODE_ENV}`),Ce(Lr,t)));ee.onRequest("loadCommand",t=>(W(`Server connection (${t.sessionId}) loadCommand: ${t.launchType}`),Ce(Ar,t)));ee.onRequest("loadTool",t=>(W(`Server connection (${t.sessionId}) loadTool`),Ce($r,t)));ee.onRequest("unloadEntryPoint",t=>(W(`Server connection (${t.sessionId}) unloadEntryPoint`),Ce(Wr,t)));ee.onRequest("nativeCallback",t=>(W(`Server connection (${t.sessionId}) nativeCallback: ${t.callbackId}`),Ce(Dr,t)));ee.onRequest("diagnostics",t=>(W(`Server connection (${t.sessionId}) diagnostics`),Ce(qr,t)));ee.onClose(()=>{W("Server connection close"),process.exit(0)});ee.onError(t=>{let e=`Server connection error: ${t}`;j(e),process.stderr.write(`${e}
`),process.exit(1)});function Un(){ee.listen()}function An(t,e){return ee.sendRequest(t,yt(e))}function le(t,e){return ee.sendNotification(t,yt(e))}async function ze(t){let e=await zr(t);await le("commandException",e),le("commandExited",{sessionId:e.sessionId,code:e.code})}async function $n(t){let e=await zr(t);await le("captureException",e)}function yt(t){return Object.entries(t).reduce((e,[r,n])=>(e[r]=typeof n=="string"?In(n):n,e),{})}var Ce=async(t,e)=>{try{return await t(e)}catch(r){let n=C.tryDeserialize(r)??new C(r,8,"Worker Request Error");n.sessionId||(n.sessionId=e.sessionId);let i=yt(n.serialize());try{i=await zr(n)}catch(c){j(`Could not perform source mapping: ${c}`)}throw new Error(JSON.stringify(yt(i)))}},zr=t=>new Promise((e,r)=>{if(typeof t.message>"u"||!t.stack)return e(t.serialize());W(`Source mapping worker for (${t.sessionId}): initializing`);let n=new Bn.Worker((0,Hn.join)(__dirname,"..","source-mapper","index.js"),{workerData:{id:t.sessionId,message:t.message,stack:t.stack},stdin:!0,stdout:!0,stderr:!0,resourceLimits:{maxOldGenerationSizeMb:100}}),i=setTimeout(async()=>{n.removeAllListeners(),await n.terminate(),r(new Error("Source Map worker timed out after 10 seconds"))},10*1e3);n.on("message",c=>{clearTimeout(i),W(`Source mapping worker for (${t.sessionId}): finished`),e({...t.serialize(),message:c.message,stack:c.stack})}),n.on("error",c=>{clearTimeout(i),r(c)}),n.on("messageerror",c=>{clearTimeout(i),r(c)}),n.on("exit",c=>{clearTimeout(i),W(`Source mapping worker for (${t.sessionId}): exited with code ${c}`)})});function Vn(){console.log=He("debug"),console.dir=console.log,console.debug=He("debug"),console.info=He("info"),console.warn=He("warn"),console.error=He("error")}function He(t){return function(e,...r){try{let n=(0,Fn.formatWithOptions)({showHidden:!1},e,...r);le("log",{level:t,message:n,params:[]})}catch{process.stderr.write("Failed logging message: "+String(e)+", params: "+String(r))}}}process.title="Raycast Helper (Extensions)";process.on("uncaughtException",t=>{let e=`uncaughtException: ${t}`;j(e),process.stderr.write(`${e}
`),process.exit(1)});process.on("unhandledRejection",(t,e)=>{let r=`unhandledRejection: ${t}`;j(r),process.stderr.write(`${r}
`),process.exit(1)});Vn();Un();
